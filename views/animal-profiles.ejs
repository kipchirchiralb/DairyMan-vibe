<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Animal Profiles Dashboard</title>
    <link rel="stylesheet" href="dashboard.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.9.4/Chart.js"></script>
    <script src="mobile-nav.js"></script>
  </head>
  <body>
    <%- include("_dashheader.ejs")%>
    <main>
      <%- include("_dashnav.ejs")%>
      <section class="main-content">
        <% if (locals.successMessage) { %>
        <div class="success-message">
          <p><%= locals.successMessage %></p>
          <button class="close-success">Ã—</button>
        </div>
        <% } %>

        <div class="section-header">
          <h2>Per animal Production Chart</h2>
          <button class="btn" id="addAnimal">Add New Animal</button>
        </div>
        <div class="chart-wrapper">
          <canvas id="myChart" class="animal-chart"></canvas>
        </div>

        <script>
          const xValues = <%- JSON.stringify(animals[0]) %>
          const yValues = <%= JSON.stringify(animals[1]) %>
          const barColors = [
            "#b91d47",
            "#00aba9",
            "#2b5797",

          ];

          new Chart("myChart", {
            type: "pie",
            data: {
              labels: xValues,
              datasets: [{
                backgroundColor: barColors,
                data: yValues
              }]
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              plugins: {
                title: {
                  display: true,
                  text: "Per animal Production Chart",
                  font: {
                    size: 16,
                    weight: 'bold'
                  }
                },
                legend: {
                  position: 'bottom',
                  labels: {
                    padding: 20,
                    usePointStyle: true
                  }
                }
              }
            }
          });
        </script>

        <div class="all-animals-info">
          <% allAnimalsForFarmer.forEach(animal=>{ %>

          <div class="animal-card">
            <h3><%= animal.name %> (<%= animal.animal_tag %>)</h3>
            <p><strong>Breed:</strong> <%= animal.breed %></p>
            <p>
              <strong>Age:</strong> <%= new Date().getFullYear() - new
              Date(animal.dob).getFullYear() %>
            </p>
            <p>
              <strong>Status:</strong>
              <span
                class="status-badge status-<%= animal.status.toLowerCase() %>"
              >
                <%= animal.status %>
              </span>
            </p>
            <div class="animal-actions">
              <button
                class="btn btn-small update-status-btn"
                data-animal-id="<%= animal.animal_tag %>"
                data-current-status="<%= animal.status %>"
              >
                Update Status
              </button>
            </div>
          </div>

          <% }) %>
        </div>
        <div class="form-container">
          <div class="form-header">
            <h2>Animal Registration Form</h2>
            <button id="close">Close</button>
          </div>
          <form id="animalForm" action="/new-animal" method="POST">
            <div class="form-group">
              <label for="animal_tag"
                >Animal Tag <span class="required">*</span></label
              >
              <input
                type="text"
                id="animal_tag"
                name="animal_tag"
                maxlength="20"
                required
              />
            </div>

            <div class="form-group">
              <label for="name"
                >Animal Name <span class="required">*</span></label
              >
              <input
                type="text"
                id="name"
                name="name"
                maxlength="100"
                required
              />
            </div>

            <div class="form-row">
              <div class="form-group">
                <label for="dob"
                  >Date of Birth <span class="required">*</span></label
                >
                <input type="date" id="dob" name="dob" required />
              </div>

              <div class="form-group">
                <label for="purchase_date">Purchase Date</label>
                <input type="date" id="purchase_date" name="purchase_date" />
              </div>
            </div>

            <div class="form-group">
              <label for="breed">Breed</label>
              <input
                type="text"
                id="breed"
                name="breed"
                maxlength="100"
                placeholder="e.g., Holstein, Angus, etc."
              />
            </div>

            <div class="form-row">
              <div class="form-group">
                <label for="gender"
                  >Gender <span class="required">*</span></label
                >
                <select id="gender" name="gender" required>
                  <option value="">Select Gender</option>
                  <option value="Male">Male</option>
                  <option value="Female">Female</option>
                </select>
              </div>

              <div class="form-group">
                <label for="source"
                  >Source <span class="required">*</span></label
                >
                <select id="source" name="source" required>
                  <option value="">Select Source</option>
                  <option value="Birth">Birth</option>
                  <option value="Purchase">Purchase</option>
                </select>
              </div>
            </div>

            <div class="form-group">
              <label for="status">Status <span class="required">*</span></label>
              <select id="status" name="status" required>
                <option value="Alive" selected>Alive</option>
                <option value="Dead">Dead</option>
                <option value="Sold">Sold</option>
              </select>
            </div>

            <button type="submit" class="submit-btn">Register Animal</button>
          </form>
        </div>

        <!-- Status Update Form Modal -->
        <div class="form-container" id="statusUpdateForm">
          <div class="form-header">
            <h2>Update Animal Status</h2>
            <button id="closeStatusForm">Close</button>
          </div>
          <form
            id="statusUpdateFormElement"
            action="/update-animal-status"
            method="POST"
          >
            <input type="hidden" id="animalId" name="animal_id" />

            <div class="form-group">
              <label for="animalName">Animal Name</label>
              <input type="text" id="animalName" name="animal_name" readonly />
            </div>

            <div class="form-group">
              <label for="currentStatus">Current Status</label>
              <input
                type="text"
                id="currentStatus"
                name="current_status"
                readonly
              />
            </div>

            <div class="form-group">
              <label for="newStatus"
                >New Status <span class="required">*</span></label
              >
              <select id="newStatus" name="new_status" required>
                <option value="">Select New Status</option>
                <option value="Alive">Alive</option>
                <option value="Dead">Dead</option>
                <option value="Sold">Sold</option>
              </select>
            </div>

            <div class="form-group">
              <label for="statusDate"
                >Status Change Date <span class="required">*</span></label
              >
              <input type="date" id="statusDate" name="status_date" required />
            </div>

            <div class="form-group">
              <label for="statusNotes">Notes (Optional)</label>
              <textarea
                id="statusNotes"
                name="status_notes"
                rows="3"
                placeholder="Add any notes about the status change..."
              ></textarea>
            </div>

            <button type="submit" class="submit-btn">Update Status</button>
          </form>
        </div>
      </section>
    </main>

    <script>
      document
        .getElementById("animalForm")
        .addEventListener("submit", function (e) {
          // Basic form validation
          const animalTag = document.getElementById("animal_tag").value;
          const name = document.getElementById("name").value;
          const dob = document.getElementById("dob").value;
          const gender = document.getElementById("gender").value;
          const source = document.getElementById("source").value;

          if (!animalTag || !name || !dob || !gender || !source) {
            alert("Please fill in all required fields.");
            e.preventDefault();
            return;
          }
        });

      // Show/hide purchase date based on source selection
      document.getElementById("source").addEventListener("change", function () {
        const purchaseDateGroup = document
          .getElementById("purchase_date")
          .closest(".form-group");
        if (this.value === "Purchase") {
          purchaseDateGroup.style.display = "block";
          document.getElementById("purchase_date").required = true;
        } else {
          purchaseDateGroup.style.display = "block"; // Keep visible but not required
          document.getElementById("purchase_date").required = false;
        }
      });

      // show/hide form

      document
        .getElementById("addAnimal")
        .addEventListener("click", function () {
          document.querySelector(".form-container").style.display = "block";
        });
      document.getElementById("close").addEventListener("click", function () {
        document.querySelector(".form-container").style.display = "none";
      });

      // Status update functionality
      document.querySelectorAll(".update-status-btn").forEach((button) => {
        button.addEventListener("click", function () {
          const animalId = this.getAttribute("data-animal-id");
          const currentStatus = this.getAttribute("data-current-status");
          const animalName =
            this.closest(".animal-card").querySelector("h3").textContent;

          // Populate the status update form
          document.getElementById("animalId").value = animalId;
          document.getElementById("animalName").value = animalName;
          document.getElementById("currentStatus").value = currentStatus;
          document.getElementById("statusDate").value = new Date()
            .toISOString()
            .split("T")[0];

          // Show the status update form
          document.getElementById("statusUpdateForm").style.display = "block";
        });
      });

      // Close status update form
      document
        .getElementById("closeStatusForm")
        .addEventListener("click", function () {
          document.getElementById("statusUpdateForm").style.display = "none";
        });

      // Status update form validation
      document
        .getElementById("statusUpdateFormElement")
        .addEventListener("submit", function (e) {
          const newStatus = document.getElementById("newStatus").value;
          const statusDate = document.getElementById("statusDate").value;

          if (!newStatus || !statusDate) {
            alert("Please fill in all required fields.");
            e.preventDefault();
            return;
          }

          // Confirm status change
          const animalName = document.getElementById("animalName").value;
          const currentStatus = document.getElementById("currentStatus").value;

          if (
            !confirm(
              `Are you sure you want to change ${animalName}'s status from "${currentStatus}" to "${newStatus}"?`
            )
          ) {
            e.preventDefault();
            return;
          }
        });

      // Close success message
      const closeSuccessBtn = document.querySelector(".close-success");
      if (closeSuccessBtn) {
        closeSuccessBtn.addEventListener("click", function () {
          this.closest(".success-message").style.display = "none";
        });
      }
    </script>
  </body>
</html>
